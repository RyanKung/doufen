<template class="page">
    <style scoped>
        #account {
            padding: 20px;
        }

        #account webview {
            height: 620px;
        }

        #account .loading {
            display: none;
            position: absolute;
            width: 200px;
            left: 50%;
            margin: 260px 0 auto -100px;
        }

        #account .action-refresh {
            float: right;
        }
    </style>
    <div class="container-fluid" id="account">
        <ol class="breadcrumb">
            <li>
                <a href="dashborad.html" class="navigate-link">控制台</a>
            </li>
            <li class="active">新增帐号</li>
        </ol>
        <div class="alert alert-warning alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <strong>注意：</strong>程序使用豆瓣官方网页登录，不会获取和保存你的密码。为了保障你的帐号安全，请从官方渠道下载本软件。
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">登录豆瓣帐号
                <a class="btn btn-default btn-xs action-refresh" href="#" role="button">
                    <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> 重新加载
                </a>
            </div>
            <div class="panel-body">
                <div class="well well-lg loading">加载中……</div>
            </div>
        </div>
    </div>
    <script>
        ((electron, module) => {
            document.title = '新增帐号'

            const cookie = system.require('cookie')

            let $loadingBanner = $('#account .loading')
            let $loginWebView = $('<webview>')
                .attr('src', 'https://www.douban.com/login')
                .attr('httpreferrer', 'https://www.douban.com/')
                .attr('partition', 'douban-' + Date.now())
                .attr('nodeIntegration', 'nodeIntegration')
                .addClass('embed-responsive-item')
                .appendTo('#account .panel-body')

            let webContents;
            $loginWebView.on('did-start-loading', function () {
                $loadingBanner.css('display', 'block')
                $(this).css('opacity', '0.1')
            }).on('did-stop-loading', function () {
                $loadingBanner.css('display', 'none')
                $(this).css('opacity', '1')
            }).on('load-commit', () => {
                if (webContents) return
                webContents = $loginWebView[0].getWebContents()
                webContents.session.webRequest.onSendHeaders({ urls: ['https://*.douban.com/*'] }, (details) => {
                    let cookies = details.requestHeaders.Cookie
                    if (!cookies) return
                    let cookiePairs = cookie.parse(details.requestHeaders.Cookie)
                    if ('dbcl2' in cookiePairs) {
                        webContents.stop()
                        window.alert('登录成功！', '信息')
                        system.shared('service.authorization.add')(cookies)
                        system.navigate('dashborad.html')
                    }
                })
            })

            const DOUBAN_LOGIN_URL = $loginWebView.attr('src')
            $('#account .action-refresh').click(() => {
                $loginWebView[0].loadURL(DOUBAN_LOGIN_URL)
            })

        })(system.require('electron'), 'account')
    </script>
</template>