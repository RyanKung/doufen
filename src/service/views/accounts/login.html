{% extends "../theme.html" %} 

{% block title %}登录{% end %}

{% block head_extra %}
<style>
    #component-webview {
        margin-top: 10px;
    }

    #component-webview>webview {
        height: 620px;
    }

    #component-webview>span {
        position: absolute;
        top: 0px;
        margin-top: 0;
        float: left;
    }
</style>
{% end %}

{% block content %}
<div class="container">
    <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li>
                <a href="{{ reverse_url('index') }}">主页</a>
            </li>
            <li>
                <a href="/accounts">账号</a>
            </li>
            <li class="is-active">
                <a href="#" aria-current="page">登录</a>
            </li>
        </ul>
    </nav>

    <article class="message is-danger">
        <div class="message-body">程序使用豆瓣官方网页登录，不会获取和保存你的密码。为了保障你的帐号安全，请从官方渠道下载本软件。</div>
    </article>

    <div class="field-body">
        <div class="field is-grouped">
            <p class="control is-expanded">
                <input class="input" id="input-address" type="text" readonly placeholder="地址栏">
            </p>
            <p class="control">
                <a class="button is-primary" id="button-refresh">
                    <span class="icon">
                        <i class="fas fa-sync-alt"></i>
                    </span>
                    <span>刷新</span>
                </a>
            </p>
            <p class="control">
                <a class="button" id="button-reset">
                    <span class="icon">
                        <i class="fas fa-undo-alt"></i>
                    </span>
                    <span>返回登录页</span>
                </a>
            </p>
        </div>
    </div>

{% import time %}
    <div class="container" id="component-webview">
        <span class="tag is-info is-medium is-invisible">Loading...</span>
        <webview id="webview-douban" src="https://www.douban.com/login" httpreferrer="https://www.douban.com/" partition="douban-{{ time.time() }}" nodeIntegration></webview>
    </div>
</div>
{% end %}

{% block body_extra %}
<script>
    system.on('loaded', () => {
        const cookie = system.require('cookie')

        let webContents
        let $loadingTag = $('#component-webview>span')

        let $webview = $('#component-webview>webview').on('load-commit', function() {
            $('#input-address').val(this.getURL())
            if (webContents) return
            webContents = this.getWebContents()
            webContents.session.webRequest.onSendHeaders({ urls: ['https://*.douban.com/*'] }, (details) => {
                let cookies = details.requestHeaders.Cookie
                if (!cookies) return
                let cookiePairs = cookie.parse(details.requestHeaders.Cookie)
                if ('dbcl2' in cookiePairs) {
                    webContents.stop()
                    window.alert('登录成功！', '信息')
                    console.log(cookies)
                }
            })
        }).on('did-start-loading', () => {
            $loadingTag.removeClass('is-invisible')
        }).on('did-stop-loading', () => {
            $loadingTag.addClass('is-invisible')
        })

        $('#button-refresh').click(() => {
            $webview[0].reload()
        })

        $('#button-reset').click(() => {
            $webview[0].loadURL('https://www.douban.com/login')
        })
    })
</script>
{% end %}
